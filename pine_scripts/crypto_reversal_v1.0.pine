//@version=5
strategy("Crypto Reversal Strategy v1.0", 
         overlay=true, 
         margin_long=100, 
         margin_short=100,
         initial_capital=10000,
         default_qty_type=strategy.percent_of_equity,
         default_qty_value=2)

rsiLength = input.int(14, "RSI Length", minval=1)
rsiOverbought = input.int(70, "RSI Overbought", minval=50, maxval=100)
rsiOversold = input.int(30, "RSI Oversold", minval=0, maxval=50)

macdFast = input.int(12, "MACD Fast", minval=1)
macdSlow = input.int(26, "MACD Slow", minval=1)
macdSignal = input.int(9, "MACD Signal", minval=1)

bbLength = input.int(20, "BB Length", minval=1)
bbStdDev = input.float(2.0, "BB StdDev", minval=0.1, maxval=5.0)

emaShort = input.int(9, "EMA Short", minval=1)
emaLong = input.int(21, "EMA Long", minval=1)

stopLossPercent = input.float(1.5, "Stop Loss %", minval=0.1, maxval=5.0)
takeProfitPercent = input.float(3.0, "Take Profit %", minval=0.1, maxval=10.0)

enableCombo = input.bool(true, "Enable Combo Features")
enableVolume = input.bool(true, "Enable Volume Filter")
enableTrendFilter = input.bool(true, "Enable Trend Filter")

rsi = ta.rsi(close, rsiLength)
[macdLine, signalLine, histLine] = ta.macd(close, macdFast, macdSlow, macdSignal)
[bbMiddle, bbUpper, bbLower] = ta.bb(close, bbLength, bbStdDev)

emaS = ta.ema(close, emaShort)
emaL = ta.ema(close, emaLong)

macdGoldenCross = ta.crossover(macdLine, signalLine)
macdDeathCross = ta.crossunder(macdLine, signalLine)

bbSqueeze = (bbUpper - bbLower) < ((ta.highest(high, 20) - ta.lowest(low, 20)) * 0.3)

rsiOversoldSignal = rsi < rsiOversold
rsiOverboughtSignal = rsi > rsiOverbought

rsiRising = ta.rising(rsi, 2)
rsiFalling = ta.falling(rsi, 2)

volumeMA = ta.sma(volume, 20)
volumeFilter = volume > volumeMA * 1.1

trendUp = enableTrendFilter ? (close > ta.sma(close, 50) and rsi > 45) : true
trendDown = enableTrendFilter ? (close < ta.sma(close, 50) and rsi < 55) : true

comboFeature1 = (close - open) / (high - low)
comboFeature2 = (high - close) / (high - low)
comboFeature3 = volume / volumeMA

buySignal = (rsiOversoldSignal or (rsiRising and rsi < 50)) and 
            (macdGoldenCross or (macdLine > signalLine and histLine > 0)) and
            (bbSqueeze or close < bbLower) and
            volumeFilter and
            trendUp and
            emaS > emaL

sellSignal = (rsiOverboughtSignal or (rsiFalling and rsi > 50)) and
             (macdDeathCross or (macdLine < signalLine and histLine < 0)) and
             (bbSqueeze or close > bbUpper) and
             volumeFilter and
             trendDown and
             emaS < emaL

if buySignal and strategy.position_size == 0
    strategy.entry("Long", strategy.long, comment="Buy Signal")

if sellSignal and strategy.position_size == 0
    strategy.entry("Short", strategy.short, comment="Sell Signal")

if strategy.position_size > 0
    longStop = strategy.position_avg_price * (1 - stopLossPercent / 100)
    longProfit = strategy.position_avg_price * (1 + takeProfitPercent / 100)
    strategy.exit("Long Exit", "Long", stop=longStop, limit=longProfit)

if strategy.position_size < 0
    shortStop = strategy.position_avg_price * (1 + stopLossPercent / 100)
    shortProfit = strategy.position_avg_price * (1 - takeProfitPercent / 100)
    strategy.exit("Short Exit", "Short", stop=shortStop, limit=shortProfit)

plot(bbUpper, "BB Upper", color=color.new(color.blue, 30))
plot(bbMiddle, "BB Middle", color=color.new(color.gray, 50))
plot(bbLower, "BB Lower", color=color.new(color.blue, 30))

plot(emaS, "EMA Short", color=color.new(color.orange, 0))
plot(emaL, "EMA Long", color=color.new(color.purple, 0))

var color bgColor = na
if buySignal
    bgColor := color.new(color.green, 95)
if sellSignal
    bgColor := color.new(color.red, 95)
if bgColor != na
    bgcolor(bgColor, editable=false)
